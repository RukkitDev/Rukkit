/*
 * This build file was generated by the Gradle 'init' task.
 *
 * This generated file contains a commented-out sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * user guide available at https://docs.gradle.org/4.4.1/userguide/tutorial_java_projects.html
 */

// Apply the java plugin to add support for Java
plugins {
    id 'java'
    id 'application'
    id 'com.github.johnrengelman.shadow' version '7.0.0'
}

[compileJava, compileTestJava, javadoc]*.options*.encoding = 'UTF8'

// 版本配置
final def RUKKIT_VERSION = project.hasProperty('rukkitVersion') ? rukkitVersion : 'UNKNOWN'
final def BUILD_TIMESTAMP = new Date().format('yyyyMMdd-HHmmss')
final def GIT_COMMIT = 'git rev-parse --short HEAD'.execute().text.trim()

mainClassName = 'cn.rukkit.RukkitLauncher'

// In this section you declare where to find the dependencies of your project
repositories {
    // Use 'jcenter' for resolving your dependencies.
    // You can declare any Maven/Ivy/file repository here.
    mavenCentral()
}

// In this section you declare the dependencies for your production and test code
dependencies {
    // The production code uses the SLF4J logging API at compile time
    // compile 'org.slf4j:slf4j-api:1.7.25'
    implementation 'com.alibaba.fastjson2:fastjson2:2.0.41'
    implementation 'org.jline:jline-terminal:3.25.0'
    implementation 'org.jline:jline-console:3.25.0'
    implementation 'org.jline:jline:3.25.0'
    implementation 'org.jline:jline-reader:3.25.0'
    implementation 'org.jline:jline-terminal-jna:3.25.0'
    // https://mvnrepository.com/artifact/io.netty/netty-all
    implementation 'io.netty:netty-all:4.1.100.Final'
    implementation 'ch.qos.logback:logback-core:1.4.14'
    implementation 'ch.qos.logback:logback-classic:1.4.12'
    implementation 'org.slf4j:slf4j-api:2.0.7'
    implementation 'org.yaml:snakeyaml:2.0'


    //compile 'netty'
    // Declare the dependency for your favourite test framework you want to use in your tests.
    // TestNG is also supported by the Gradle Test task. Just change the
    // testCompile dependency to testCompile 'org.testng:testng:6.8.1' and add
    // 'test.useTestNG()' to your build script.
    //testCompile 'junit:junit:4.12'
}

tasks.withType(Javadoc).configureEach {
    options.encoding = 'UTF-8'
}

// 处理版本资源文件
tasks.register('processVersionResources') {
    doLast {
        def props = new Properties()
        props.setProperty('rukkit.version', RUKKIT_VERSION)
        props.setProperty('build.timestamp', BUILD_TIMESTAMP)
        props.setProperty('git.commit', GIT_COMMIT ?: 'unknown')

        def outputFile = file('build/resources/main/rukkit-version.properties')
        outputFile.parentFile.mkdirs()

        def writer = new FileWriter(outputFile)
        props.store(writer, 'Rukkit Version Information - Generated by Gradle')
        writer.close()
    }
}

processResources.dependsOn processVersionResources

// Shadow Jar配置
shadowJar {
    archiveBaseName = 'Rukkit'
    archiveClassifier = ''
    archiveVersion = RUKKIT_VERSION
    
    manifest {
        attributes(
            'Main-Class': 'cn.rukkit.RukkitLauncher',
            'Implementation-Version': RUKKIT_VERSION,
            'Build-Timestamp': BUILD_TIMESTAMP,
            'Git-Commit': GIT_COMMIT
        )
    }
    
    // 排除签名文件避免冲突
    exclude 'META-INF/*.SF'
    exclude 'META-INF/*.DSA'
    exclude 'META-INF/*.RSA'
}

// 自定义构建任务
tasks.register('buildRukkit') {
    group = 'build'
    description = 'Build Rukkit distribution package'
    dependsOn shadowJar
    
    doLast {
        def outputDir = layout.buildDirectory.dir('outputs').get().asFile
        outputDir.mkdirs()

        def append = ""

        if (buildType != 'release') {
            append = "${RUKKIT_VERSION}-${buildType}-${BUILD_TIMESTAMP}"
        } else {
            append = "${RUKKIT_VERSION}"
        }
        
        // 复制JAR文件
        copy {
            from shadowJar.archiveFile
            into outputDir
            rename {
                return "Rukkit-${append}.jar"
            }
        }
        
        // 复制启动脚本
        copy {
            from 'start.sh', 'start.bat'
            into outputDir
        }
        
        // 复制libs目录（如果有）
        if (file('libs').exists()) {
            copy {
                from 'libs'
                into "${outputDir}/libs"
            }
        }
        
        // 复制data目录（如果有）
        if (file('data').exists()) {
            copy {
                from 'data'
                into "${outputDir}/data"
            }
        }
        
        // 替换版本号
        ant.replace(file: "${outputDir}/start.sh", token: '{version}', value: append)
        ant.replace(file: "${outputDir}/start.bat", token: '{version}', value: append)
        
        println """
          -- Build Complete! --
Target Rukkit Version: ${RUKKIT_VERSION}
Output Location: ${outputDir}
Files Generated:
  - Rukkit-${append}.jar
  - start.sh
  - start.bat"""
        if (file('libs').exists()) {
            println "  - libs/ (依赖库)"
        }
        if (file('data').exists()) {
            println "  - data/ (数据文件)"
        }
        if (buildType != 'release') {
            println "\nNon-release Build Info:"
            println "  Timestamp: ${BUILD_TIMESTAMP}"
            println "  Git Commit: ${GIT_COMMIT}"
        }
    }
}

// 清理任务
clean {
    // delete 'build/outputs'
}

// 默认任务
defaultTasks 'buildRukkit'
